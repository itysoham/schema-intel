name: Schema Intelligence - PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.sql'
      - '**/migrations/**'
      - '**/flyway/**'
      - 'db/**'

# Give permissions to write comments
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  schema-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for comparison
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Get changed SQL files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **.sql
            **/migrations/**
            **/flyway/**
            db/**
      
      - name: Display changed files
        run: |
          echo "Changed SQL files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
      
      - name: Analyze schema changes
        id: analyze
        env:
          SCHEMA_INTELLIGENCE_API: ${{ secrets.SCHEMA_INTELLIGENCE_API_URL }}
          SCHEMA_INTELLIGENCE_TOKEN: ${{ secrets.SCHEMA_INTELLIGENCE_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Call Schema Intelligence API for analysis
          FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          
          # Create payload with file changes
          PAYLOAD=$(cat <<EOF
          {
            "pr_number": ${{ github.event.pull_request.number }},
            "repository": "${{ github.repository }}",
            "base_ref": "${{ github.event.pull_request.base.ref }}",
            "head_ref": "${{ github.event.pull_request.head.ref }}",
            "files": $(echo "$FILES" | jq -R -s -c 'split(" ")')
          }
          EOF
          )
          
          # Call API (note: endpoint includes /api)
          echo "Calling API: $SCHEMA_INTELLIGENCE_API/api/v1/cicd/analyze"
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SCHEMA_INTELLIGENCE_TOKEN" \
            -d "$PAYLOAD" \
            "$SCHEMA_INTELLIGENCE_API/api/v1/cicd/analyze")
          
          # Check if response is valid JSON (not HTML error page)
          if echo "$RESPONSE" | jq . > /dev/null 2>&1; then
            echo "$RESPONSE" > analysis-result.json
          else
            echo "Error: API returned non-JSON response"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          # Extract score and critical issues from data object
          SCORE=$(echo "$RESPONSE" | jq -r '.data.score // 0')
          CRITICAL=$(echo "$RESPONSE" | jq -r '.data.issues[]? | select(.severity=="CRITICAL") | length' | wc -l | tr -d ' ')
          HIGH=$(echo "$RESPONSE" | jq -r '.data.issues[]? | select(.severity=="HIGH") | length' | wc -l | tr -d ' ')
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
      
      - name: Validate against policy
        id: validate
        env:
          MIN_SCORE: 70
          ALLOW_CRITICAL: 0
        run: |
          SCORE=${{ steps.analyze.outputs.score }}
          CRITICAL=${{ steps.analyze.outputs.critical }}
          
          if [ "$SCORE" -lt "$MIN_SCORE" ]; then
            echo "❌ Schema score ($SCORE) is below minimum threshold ($MIN_SCORE)"
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ "$CRITICAL" -gt "$ALLOW_CRITICAL" ]; then
            echo "❌ Found $CRITICAL critical issue(s). Maximum allowed: $ALLOW_CRITICAL"
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✅ Schema validation passed"
          echo "validation_failed=false" >> $GITHUB_OUTPUT
      
      # Note: Comment is posted by backend API, not here
      # This prevents duplicate comments
      - name: Analysis complete
        if: always()
        run: |
          echo "✅ Schema analysis completed"
          echo "Comment posted by backend API with CrewAI analysis"
      
      - name: Fail if validation failed
        if: steps.validate.outputs.validation_failed == 'true'
        run: |
          echo "❌ Schema validation failed. Fix the issues above before merging."
          exit 1

